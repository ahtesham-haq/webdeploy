name: Deploy to IIS Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Install WinRM
        run: |
          Install-Module -Name PSRemoting -Force -SkipPublisherCheck

      - name: Deploy to IIS via PowerShell
        run: |
          $password = ConvertTo-SecureString ${{ secrets.IIS_PASSWORD }} -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential(${{ secrets.IIS_USERNAME }}, $password)
          Invoke-Command -ComputerName ${{ secrets.IIS_SERVER }} -Credential $cred -ScriptBlock {
              cd 'D:\Ahtesham ul haq\Projects\Learning\Github\webdeploy\WebApplicationMy'
              git pull https://$env:GITHUB_USER:$env:GITHUB_PAT@github.com/ahtesham-haq/webdeploy.git
          }
        shell: pwsh
    env:
        GITHUB_USER: ${{ secrets.GITHUBUSER }}
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
